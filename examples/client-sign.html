<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>x402 Mint - Sign & Send Example</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Ethers v6 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <style>
      body { font-family: system-ui, Arial; padding: 24px; max-width: 800px; }
      pre { background:#111; color:#eee; padding:12px; border-radius:6px; overflow:auto }
      input, button { padding:8px 10px; font-size:14px }
    </style>
  </head>
  <body>
    <h1>x402 Mint â€” Sign & Send Example</h1>
    <p>This page demonstrates how to create an EIP-712 TransferWithAuthorization signature and send the x402 POST (X-Payment header) to the deployed Netlify function.</p>

    <div>
      <label>Function URL (deployed):</label>
      <input id="fnUrl" value="https://mint.x402hood.xyz/.netlify/functions/mint" style="width:100%" />
    </div>

    <p>
      <button id="connect">Connect Wallet</button>
      <button id="signSend" disabled>Sign & Send 1 USDC</button>
    </p>

    <h3>Console</h3>
    <pre id="out">Not connected</pre>

    <script>
      const out = (s) => { document.getElementById('out').textContent += '\n' + s }
      const setOut = (s) => { document.getElementById('out').textContent = s }

      const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
      const NFT_RECIPIENT = '0x2e6e06f71786955474d35293b09a3527debbbfce';
      const MINT_PRICE = '1000000'; // 1 USDC in 6-decimal units

      let provider, signer, account;

      document.getElementById('connect').onclick = async () => {
        if (!window.ethereum) return alert('Please install MetaMask or another EIP-1193 provider');
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = await provider.getSigner();
        account = await signer.getAddress();
        setOut('Connected: ' + account);
        document.getElementById('signSend').disabled = false;
      };

      document.getElementById('signSend').onclick = async () => {
        try {
          setOut('Preparing signature...');

          const network = await signer.provider.getNetwork();
          const chainId = network.chainId;

          // Build EIP-712 domain and types to match server
          const domain = {
            name: 'FiatTokenV2',
            version: '1',
            chainId,
            verifyingContract: USDC_ADDRESS
          };

          const types = {
            TransferWithAuthorization: [
              { name: 'from', type: 'address' },
              { name: 'to', type: 'address' },
              { name: 'value', type: 'uint256' },
              { name: 'validAfter', type: 'uint256' },
              { name: 'validBefore', type: 'uint256' },
              { name: 'nonce', type: 'bytes32' }
            ]
          };

          const now = Math.floor(Date.now()/1000);
          const authorization = {
            from: account,
            to: NFT_RECIPIENT,
            value: MINT_PRICE,
            validAfter: '0',
            validBefore: String(now + 60*60),
            nonce: ethers.hexlify(ethers.getRandomValues ? ethers.getRandomValues(new Uint8Array(32)) : ethers.randomBytes(32))
          };

          setOut('Signing with EIP-712 typed data...');
          // Use signer._signTypedData (ethers v6)
          const signature = await signer._signTypedData(domain, types, authorization);

          setOut('Signature created:\n' + signature + '\n\nAuthorization:\n' + JSON.stringify(authorization, null, 2));

          // Build x402 payload and base64 it in header
          const payload = {
            x402Version: 1,
            scheme: 'exact',
            network: 'base',
            payload: {
              signature,
              authorization
            }
          };

          const json = JSON.stringify(payload);
          // base64 encode in browser-safe way
          const b64 = btoa(unescape(encodeURIComponent(json)));

          const url = document.getElementById('fnUrl').value;
          setOut('Sending X-Payment to ' + url + '...');

          const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Payment': b64 } });
          const data = await resp.json().catch(()=>({}));
          setOut('Response status: ' + resp.status + '\n' + JSON.stringify(data, null, 2));
        } catch (err) {
          setOut('Error: ' + err.message + '\n' + (err.stack||''));
        }
      };
    </script>
  </body>
</html>
